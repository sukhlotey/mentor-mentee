{% extends "templates/base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center">Mentor Mentee System</h2>

    <input type="text" id="searchInput" class="form-control form-control-lg p-6 mt-3 w-75 mx-auto"
           placeholder="Search by name..."
           value="{{ search_query | default('') }}">

    <div class="row mt-4">
        <div class="col-md-4">
            <h4>Instructors</h4>
            <ul id="instructors-list" class="list-group">
                {% for instructor in instructors %}
                <li class="list-group-item instructor-item" data-instructor="{{ instructor.name }}">
                    {{ instructor.name }}
                </li>
                {% endfor %}
            </ul>
        </div>

        <div class="col-md-4">
            <h4>Students</h4>
            <ul id="students-list" class="list-group">
                {% for student in students %}
                <li class="list-group-item student-item" data-student="{{ student.name }}" data-image="{{ student.image }}" data-guardians="{{ student.guardian_names }}">
                    {{ student.student_name }}
                    {% if student.student_email_id %}
                    <br><small class="text-muted">{{ student.student_email_id }}</small>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>

        <div class="col-md-4">
            <h4>Details</h4>
            <div id="details-list">
                <p>Select an instructor or student to view details.</p>
            </div>
        </div>
    </div>

    <div class="mt-4" id="pagination-section" {% if search_query %}style="display: none;"{% endif %}>
        <div class="d-flex justify-content-between align-items-center">
            <div id="page-length-buttons">
                <button class="btn btn-secondary page-length-btn" data-length="20">20</button>
                <button class="btn btn-secondary page-length-btn" data-length="100">100</button>
                <button class="btn btn-secondary page-length-btn" data-length="500">500</button>
                <button class="btn btn-secondary page-length-btn" data-length="2500">2500</button>
            </div>
            <div>
                <button class="btn btn-primary" id="load-more-btn">Load More</button>
            </div>
        </div>
    </div>
</div>
<style>
    .instructor-item, .student-item {
        cursor: pointer;
        position: relative;
    }
    .selected {
        background-color: #e6f3ff;
        transition: background-color 0.3s ease;
    }
    .instructor-item:hover, .student-item:hover {
        background-color: #f0f0f0;
    }
    .custom-tooltip {
        display: none;
        position: absolute;
        background-color: rgba(0, 0, 0, 0.5);
        color: #fff;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 1000;
        width: 200px;
        top: -100%;
        left: 50%;
        transform: translateX(-50%);
        text-align: center;
    }
    .student-item:hover .custom-tooltip {
        display: block;
    }
    .custom-tooltip img {
        width: 100px;
        height: 100px;
        border-radius:50%;
        margin-bottom: 5px;
    }
</style>
<script>
document.addEventListener("DOMContentLoaded", function () {
    let start = 0;
    let pageLength = 10; 
    let currentSearchQuery = "{{ search_query | default('') }}";
    let totalRecords = {{ total_records | default(0) }};
    let recordsLoaded = 0;
    let instructorGroups = {{ instructor_groups | tojson | safe }};
    let studentInstructors = {{ student_instructors | tojson | safe }};
    let detailsList = document.getElementById("details-list");
    let searchInput = document.getElementById("searchInput");
    let instructorsList = document.getElementById("instructors-list");
    let studentsList = document.getElementById("students-list");
    let paginationSection = document.getElementById("pagination-section");
    let loadMoreBtn = document.getElementById("load-more-btn");
    let pageLengthButtons = document.querySelectorAll(".page-length-btn");
    let selectedItem = null;

    function attachEventListeners() {
        document.querySelectorAll(".instructor-item").forEach(item => {
            item.addEventListener("click", function () {
                if (selectedItem) {
                    selectedItem.classList.remove("selected");
                }
                this.classList.add("selected");
                selectedItem = this;

                const instructorName = this.dataset.instructor;
                detailsList.innerHTML = "<p>Loading student groups...</p>";

                if (instructorGroups[instructorName] && instructorGroups[instructorName].length > 0) {
                    detailsList.innerHTML = "";
                    instructorGroups[instructorName].forEach(group => {
                        let students = group.students.length > 0 ? group.students.join(", ") : "No students assigned.";
                        detailsList.innerHTML += `
                            <div class="card mt-3">
                                <div class="card-header bg-info text-white">${group.student_group_name}</div>
                                <div class="card-body">
                                    <p><strong>Students:</strong> ${students}</p>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    detailsList.innerHTML = "<p>No student groups assigned to this instructor.</p>";
                }
            });
        });

        document.querySelectorAll(".student-item").forEach(item => {
            item.addEventListener("click", function () {
                if (selectedItem) {
                    selectedItem.classList.remove("selected");
                }
                this.classList.add("selected");
                selectedItem = this;

                const studentName = this.dataset.student;
                detailsList.innerHTML = "<p>Loading assigned instructors...</p>";

                if (studentInstructors[studentName] && studentInstructors[studentName].length > 0) {
                    detailsList.innerHTML = `<h4>Assigned Instructors</h4>`;
                    studentInstructors[studentName].forEach(instructor => {
                        detailsList.innerHTML += `
                            <div class="card mt-3">
                                <div class="p-4 rounded bg-info text-white">${instructor}</div>
                            </div>
                        `;
                    });
                } else {
                    detailsList.innerHTML = "<p>No instructor assigned to this student.</p>";
                }
            });

            const tooltip = document.createElement("div");
            tooltip.className = "custom-tooltip";
            const image = item.dataset.image;
            const guardians = item.dataset.guardians || "No guardians listed";
            tooltip.innerHTML = image ? `<img src="${image}" alt="Student Image"><br>Guardians: ${guardians}` : `Guardians: ${guardians}`;
            item.appendChild(tooltip);
        });
    }

    function updatePage(searchQuery, startOffset, append = false, itemsPerPage = pageLength) {
        frappe.call({
            method: "mentor_mentee.www.mentor_mentee.search_mentor_mentee",
            args: {
                search_query: searchQuery,
                start: startOffset,
                items_per_page: itemsPerPage
            },
            callback: function(response) {
                let data = response.message;

                if (!append) {
                    instructorsList.innerHTML = "";
                    studentsList.innerHTML = "";
                    recordsLoaded = 0; 
                }

                data.instructors.forEach(function(instructor) {
                    let li = document.createElement("li");
                    li.classList.add("list-group-item", "instructor-item");
                    li.dataset.instructor = instructor.name;
                    li.textContent = instructor.name;
                    instructorsList.appendChild(li);
                });

                data.students.forEach(function(student) {
                    let li = document.createElement("li");
                    li.classList.add("list-group-item", "student-item");
                    li.dataset.student = student.name;
                    li.dataset.image = student.image || "";
                    li.dataset.guardians = student.guardian_names || "";
                    li.innerHTML = `${student.student_name}${student.student_email_id ? '<br><small class="text-muted">' + student.student_email_id + '</small>' : ''}`;
                    studentsList.appendChild(li);
                });

                if (!append) {
                    instructorGroups = data.instructor_groups;
                    studentInstructors = data.student_instructors;
                } else {
                    Object.assign(instructorGroups, data.instructor_groups);
                    Object.assign(studentInstructors, data.student_instructors);
                }

                currentSearchQuery = data.search_query;
                totalRecords = data.total_records; 
                pageLength = data.items_per_page;
                recordsLoaded += Math.max(data.instructors.length, data.students.length);

                if (!append) {
                    detailsList.innerHTML = "<p>Select an instructor or student to view details.</p>";
                }

                console.log("Records Loaded:", recordsLoaded, "Total Records:", totalRecords, "Start:", start, "Page Length:", pageLength, "Has More:", data.has_more);

                if (searchQuery === "" && totalRecords > 0) {
                    paginationSection.style.display = "block";
                } else if (searchQuery !== "") {
                    paginationSection.style.display = "none";
                }

                loadMoreBtn.disabled = !data.has_more;
                loadMoreBtn.style.display = data.has_more ? "inline-block" : "inline-block";

                attachEventListeners();
            }
        });
    }

    pageLengthButtons.forEach(button => {
        button.addEventListener("click", function() {
            pageLength = parseInt(this.dataset.length);
            start = 0;
            updatePage(currentSearchQuery, start, false, pageLength);
            pageLengthButtons.forEach(btn => btn.classList.remove("active"));
            this.classList.add("active");
        });
    });

    loadMoreBtn.addEventListener("click", function() {
        if (!this.disabled) {
            start += pageLength; // Increment start by page length
            updatePage(currentSearchQuery, start, true, pageLength);
        }
    });

    let searchTimeout;
    searchInput.addEventListener("input", function() {
        let searchValue = this.value.trim().toLowerCase();
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
            start = 0;
            updatePage(searchValue, start, false, pageLength);
        }, 500);
    });

    searchInput.addEventListener("change", function() {
        if (this.value.trim() === "") {
            start = 0; // Reset start on clear
            updatePage("", start, false, pageLength);
        }
    });

    pageLengthButtons.forEach(button => {
        if (parseInt(button.dataset.length) === 10) {
            button.classList.add("active");
        }
    });

    attachEventListeners();
});
</script>
{% endblock %}
